pencil beam algorithm component optimization algorithm intensity modulated proton therapy impt presented pencil beam algorithm tuned special accuracy requirements impt heterogeneous geometries position distortion bragg peak lateral scatter pose problems amplified spot weight optimization heterogeneity corrections implemented multiple raytracing approach using subspots order derive nuclear interaction corrections monte carlo simulations performed contribution long ranged products nuclear interactions taken account fit monte carlo results stopping power ratios implemented scatter optional beam line accessories range shifters ripple filters taken account collimator included additional scattering finally dose distributions benchmarked monte carlo simulations showing mm agreement simple heterogeneous phantoms case complicated phantoms principal shortcomings pencil beam algorithms evident influence effects impt dose distributions shown clinical examples fluence weighted energy dependent NUMBER NUMBER